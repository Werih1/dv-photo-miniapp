<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DV-Lottery Photo Check</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #fff; color: #333; overflow: hidden; }

        /* SPLASH SCREEN */
        .splash { display: flex; flex-direction: column; align-items: center; justify-content: space-between; width: 100%; height: 100%; background: linear-gradient(rgba(25, 78, 132, 0.65), rgba(25, 78, 132, 0.65)), url('images/logo.png') center/cover no-repeat; padding: 30px 20px; position: fixed; top: 0; left: 0; z-index: 1000; }
        .splash.hidden { display: none; }
        .splash-top { flex: 0.5; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .splash-title { font-size: 32px; font-weight: 700; color: white; text-align: center; line-height: 1.2; text-shadow: 0 2px 8px rgba(0,0,0,0.3); letter-spacing: -0.5px; }
        .splash-middle { flex: 1; display: flex; align-items: center; justify-content: center; }
        .splash-bottom { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 16px; justify-content: center; }
        .splash-subtitle { font-size: 16px; color: rgba(255,255,255,0.95); height: 22px; min-height: 22px; font-weight: 500; text-align: center; margin-bottom: 12px; }
        .language-selector-splash { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; }
        .lang-btn-splash { width: 65px; height: 65px; border: 3px solid white; border-radius: 14px; background: rgba(255,255,255,0.15); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .lang-btn-splash img { width: 100%; height: 100%; object-fit: cover; border-radius: 11px; }
        .lang-btn-splash.active { transform: scale(1.08); border-color: rgba(255,255,255,0.8); box-shadow: 0 6px 20px rgba(255,255,255,0.3); }

        /* MAIN APP */
        .app { display: none; width: 100%; height: 100%; flex-direction: column; overflow: hidden; background: #f8f9fa; }
        .app.active { display: flex; }

        /* APP HEADER */
        .app-header { background: linear-gradient(135deg, #194E84 0%, #1a5a99 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .app-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .attempts-badge { display: inline-block; padding: 8px 16px; background: rgba(255,255,255,0.25); color: white; border-radius: 20px; font-weight: 600; font-size: 13px; backdrop-filter: blur(10px); }

        /* MAIN CONTENT */
        .app-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .upload-section { display: flex; flex-direction: column; gap: 12px; }
        .button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; -webkit-appearance: none; appearance: none; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, #194E84 0%, #1a5a99 100%); color: white; box-shadow: 0 4px 12px rgba(25, 78, 132, 0.3); }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        /* MENU SECTIONS */
        .menu-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .menu-item { background: white; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 100px; justify-content: center; }
        .menu-item-icon { font-size: 24px; }
        .menu-item-text { font-size: 12px; font-weight: 600; color: #194E84; line-height: 1.3; }
        .menu-item.active { border-color: #194E84; background: rgba(25, 78, 132, 0.05); transform: scale(0.98); }

        /* TAB CONTENT */
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }
        .tab-content.active { display: flex; flex-direction: column; }
        .back-btn { background: white; border: 2px solid #194E84; color: #194E84; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 16px; width: fit-content; }
        .back-btn:active { background: rgba(25, 78, 132, 0.1); }

        /* NEWS CARDS */
        .news-full-container { display: flex; flex-direction: column; gap: 16px; }
        .news-card { background: white; border-radius: 12px; padding: 16px; border-left: 4px solid #194E84; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .news-card-date { font-size: 12px; color: #194E84; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        .news-card-title { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .news-card-text { font-size: 13px; line-height: 1.6; color: #555; }

        /* PRICING */
        .promo-input-group { display: flex; gap: 8px; margin-bottom: 16px; background: white; padding: 12px; border-radius: 12px; }
        .promo-input-group input { flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; color: #333; }
        .promo-input-group input::placeholder { color: #999; font-style: italic; }
        .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .pagination-btn { padding: 8px 12px; border: 2px solid #194E84; background: white; color: #194E84; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 12px; }
        .pagination-btn.active { background: #194E84; color: white; }
        .promo-input-group button { padding: 10px 16px; background: linear-gradient(135deg, #194E84 0%, #1a5a99 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .pricing-section { display: flex; flex-direction: column; gap: 16px; }
        .pricing-card { background: white; border-radius: 12px; padding: 16px; border: 2px solid #e0e0e0; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .pricing-card.active { border-color: #194E84; box-shadow: 0 4px 12px rgba(25, 78, 132, 0.2); }
        .pricing-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .pricing-attempts { font-size: 13px; color: #194E84; font-weight: 500; margin-bottom: 10px; }
        .pricing-price { font-size: 20px; font-weight: 700; color: #194E84; margin-bottom: 12px; }
        .pricing-description-toggle { font-size: 12px; color: #194E84; font-weight: 600; text-decoration: underline; cursor: pointer; margin-bottom: 12px; transition: all 0.3s; }
        .pricing-description { display: none; font-size: 12px; line-height: 1.6; color: #666; margin-bottom: 12px; padding: 10px; background: rgba(25, 78, 132, 0.05); border-radius: 8px; }
        .pricing-description.active { display: block; }
        .btn-buy { background: linear-gradient(135deg, #194E84 0%, #1a5a99 100%); color: white; padding: 10px; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; width: 100%; }
        .btn-buy:active { transform: scale(0.98); }

        /* INSTRUCTIONS */
        .instructions { display: flex; flex-direction: column; gap: 16px; }
        .instruction-block { background: white; border-radius: 12px; padding: 16px; border-left: 4px solid #194E84; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .instruction-block h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333; }
        .instruction-block p { font-size: 13px; line-height: 1.8; color: #555; }
        .how-works-unified { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .how-works-section { margin-bottom: 16px; }
        .how-works-section:last-child { margin-bottom: 0; }
        .how-works-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333; }
        .how-works-section p { font-size: 13px; line-height: 1.8; color: #555; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div class="splash" id="splashScreen">
        <div class="splash-top">
            <div class="splash-title">DV-Lottery<br>Photo Check</div>
        </div>
        <div class="splash-middle"></div>
        <div class="splash-bottom">
            <div class="splash-subtitle" id="splashSubtitle"></div>
            <div class="language-selector-splash">
                <button class="lang-btn-splash" data-lang="ru" title="–†—É—Å—Å–∫–∏–π">
                    <img src="images/russia.png" alt="–†—É—Å—Å–∫–∏–π">
                </button>
                <button class="lang-btn-splash" data-lang="en" title="English">
                    <img src="images/united.png" alt="English">
                </button>
                <button class="lang-btn-splash" data-lang="fr" title="Fran√ßais">
                    <img src="images/france.png" alt="Fran√ßais">
                </button>
                <button class="lang-btn-splash" data-lang="ar" title="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">
                    <img src="images/emirates.png" alt="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app" id="mainApp">
        <!-- APP HEADER -->
        <div class="app-header">
            <div class="app-title" id="appTitle">DV-Lottery Photo Check</div>
            <div class="attempts-badge"><span id="attemptsLabel"></span> <span id="attemptsCount">3</span></div>
        </div>

        <!-- MAIN MENU VIEW -->
        <div id="menuView" class="app-content">
            <div class="upload-section">
                <button class="button btn-primary" id="uploadBtn"></button>
            </div>
            <div class="menu-sections">
                <div class="menu-item" id="menuHowItWorks">
                    <div class="menu-item-icon">‚ùì</div>
                    <div class="menu-item-text" id="textHowWorks"></div>
                </div>
                <div class="menu-item" id="menuNews">
                    <div class="menu-item-icon">üì∞</div>
                    <div class="menu-item-text" id="textNews"></div>
                </div>
                <div class="menu-item" id="menuPricing">
                    <div class="menu-item-icon">üí∞</div>
                    <div class="menu-item-text" id="textPricing"></div>
                </div>
                <div class="menu-item" id="menuDVForm">
                    <div class="menu-item-icon">üìã</div>
                    <div class="menu-item-text" id="textDVForm">DV-2027</div>
                </div>
                <div class="menu-item" id="menuSupport" style="grid-column: 1 -1;">
                    <div class="menu-item-icon" style="font-size: 32px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0088cc 0%, #0077b6 100%); border-radius: 8px; color: white;">
                        <img src="images/TGlogo.png" alt="Telegram" style="width: 20px; height: 20px; object-fit: contain;">
                    </div>
                    <div class="menu-item-text" id="textSupport">Telegram</div>
                </div>
            </div>
        </div>

        <!-- HOW IT WORKS -->
        <div class="tab-content" id="howWorksTab">
            <button class="back-btn" id="backBtn1"></button>
            <div class="instructions" id="howWorksListdiv"></div>
        </div>

        <!-- NEWS TAB -->
        <div class="tab-content" id="newsTab">
            <button class="back-btn" id="backBtn2"></button>
            <div class="news-full-container" id="newsFullListdiv"></div>
        </div>

        <!-- PRICING TAB -->
        <div class="tab-content" id="pricingTab">
            <button class="back-btn" id="backBtn3"></button>
            <div class="promo-input-group">
                <input type="text" id="promoCode" autocomplete="off" placeholder="">
                <button id="applyPromoBtn"></button>
            </div>
            <div class="pricing-section" id="pricingListdiv"></div>
        </div>

        <!-- DV FORM TAB -->
        <div class="tab-content" id="dvFormTab">
            <button class="back-btn" id="backBtn4"></button>
            <div class="instructions" id="dvFormListdiv"></div>
        </div>
    </div>

    <input type="file" id="photoInput" accept="image/*" style="display: none;">

    <!-- PHOTO CHECKER MODAL -->
    <div id="photoCheckerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto;">
        <div style="max-width: 100%; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh;">
            <button onclick="closePhotoChecker()" style="align-self: flex-start; background: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 20px;">‚úï</button>
            <div style="position: relative; width: 100%; max-width: 600px; aspect-ratio: 1; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <canvas id="photoCanvas" style="width: 100%; height: 100%; display: block; cursor: grab; touch-action: none;"></canvas>
            </div>
            <div style="width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; font-size: 13px; color: white;">
                <div style="display: flex; align-items: center; gap: 10px;"><div style="width: 20px; height: 20px; background: #8B0000; border-radius: 50%; border: 2px solid white;"></div><span id="lineRedLabel"></span></div>
                <div style="display: flex; align-items: center; gap: 10px;"><div style="width: 20px; height: 20px; background: #00008B; border-radius: 50%; border: 2px solid white;"></div><span id="lineBlueLabel"></span></div>
                <div style="display: flex; align-items: center; gap: 10px;"><div style="width: 20px; height: 20px; background: #006400; border-radius: 50%; border: 2px solid white;"></div><span id="lineGreenLabel"></span></div>
                <div style="display: flex; align-items: center; gap: 10px;"><div style="width: 20px; height: 20px; background: #8B6F47; border-radius: 50%; border: 2px solid white;"></div><span id="lineBrownLabel"></span></div>
            </div>
            <div style="width: 100%; max-width: 600px; display: flex; gap: 12px;">
                <button onclick="startPhotoCheck()" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">‚úì</button>
                <button onclick="closePhotoChecker()" style="flex: 1; background: #f44336; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">‚úï</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script>
        const ADMIN_IDS = [380950248, 375133882];

        // ===== TRANSLATIONS =====
        const CONTENT = {
            ru: {
                selectLanguage: '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',
                title: 'DV-Lottery Photo Check',
                attemptslabel: '–ü–æ–ø—ã—Ç–∫–∏',
                btnupload: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ',
                btnhowworks: '–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç',
                btnnews: '–ù–æ–≤–æ—Å—Ç–∏',
                btnpricing: '–¶–µ–Ω—ã',
                btndvform: 'DV-2027',
                btnsupport: 'Telegram',
                promoplaceholder: '–ö–æ–¥...',
                btnapply: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                btnback: '–ù–∞–∑–∞–¥',
                btnbuy: '–ö—É–ø–∏—Ç—å',
                descriptiontoggle: '–û–ø–∏—Å–∞–Ω–∏–µ',
                promosuccess: '–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! +5',
                promoinvalid: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥',
                uploadsuccess: '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!',
                supportlink: 'https://t.me/USAvisaPhoto',
                pricing: [
                    { name: '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ', attempts: '3 –ø—Ä–æ–≤–µ—Ä–∫–∏', price: '$0', description: '3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.' },
                    { name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', attempts: '10 –ø—Ä–æ–≤–µ—Ä–æ–∫', price: '$2.99', description: '10 –ø—Ä–æ–≤–µ—Ä–æ–∫. –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ HD.' },
                    { name: '–ü—Ä–µ–º–∏—É–º', attempts: '30 –ø—Ä–æ–≤–µ—Ä–æ–∫', price: '$6.99', description: '30 –ø—Ä–æ–≤–µ—Ä–æ–∫. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞. –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞.' },
                    { name: '–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ PRO', attempts: '–ë–µ–∑–ª–∏–º–∏—Ç', price: '$24.99', description: '–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ 6 –º–µ—Å—è—Ü–µ–≤. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7.' }
                ],
                howworks: [
                    { title: '–ß—Ç–æ —ç—Ç–æ?', text: 'DV-Lottery Photo Check –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ–π –Ω–∞ Green Card Lottery.' },
                    { title: '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?', text: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –ª–∏–Ω–∏–∏, –Ω–∞–∂–º–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤—ã–¥–∞—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.' },
                    { title: '–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º?', text: '–†–∞–∑–º–µ—Ä 600x600. –ö–∞—á–µ—Å—Ç–≤–æ. –ü–æ–ª–æ–∂–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã. –§–æ–Ω. –û—Å–≤–µ—â–µ–Ω–∏–µ. –§–æ—Ä–º–∞—Ç JPEG.' },
                    { title: '–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ?', text: '–§–æ—Ç–æ - —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞. –ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.' },
                    { title: '–ö–∞–∫ –Ω–∞—á–∞—Ç—å?', text: '3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ó–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω. –ü—Ä–æ–º–æ–∫–æ–¥—ã –≤ Telegram –∫–∞–Ω–∞–ª–µ.' }
                ],
                news: [
                    { date: '28.11.2025', title: 'DV-2027', text: '–õ–æ—Ç–µ—Ä–µ—è –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏.' },
                    { date: '27.11.2025', title: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ', text: '–£–ª—É—á—à–µ–Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü–∏–∏ –ª–∏—Ü. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 4 —è–∑—ã–∫–æ–≤.' },
                    { date: '26.11.2025', title: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤', text: '–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–º –∏ –∞—Ä–∞–±—Å–∫–æ–º.' }
                ]
            },
            en: {
                selectLanguage: 'Select language',
                title: 'DV-Lottery Photo Check',
                attemptslabel: 'Attempts left',
                btnupload: 'Upload Photo',
                btnhowworks: 'How it works',
                btnnews: 'News',
                btnpricing: 'Pricing',
                btndvform: 'DV-2027',
                btnsupport: 'Telegram',
                promoplaceholder: 'Code...',
                btnapply: 'Apply',
                btnback: 'Back',
                btnbuy: 'Buy',
                descriptiontoggle: 'Description',
                promosuccess: 'Code accepted! +5',
                promoinvalid: 'Invalid code',
                uploadsuccess: 'Photo uploaded!',
                supportlink: 'https://t.me/USAvisaPhoto',
                pricing: [
                    { name: 'Free', attempts: '3 checks', price: '$0', description: '3 free checks. Full quality analysis. Download results.' },
                    { name: 'Standard', attempts: '10 checks', price: '$2.99', description: '10 checks. Fast processing. HD download.' },
                    { name: 'Premium', attempts: '30 checks', price: '$6.99', description: '30 checks. Priority support. Batch processing.' },
                    { name: 'Agency PRO', attempts: 'Unlimited', price: '$24.99', description: 'Unlimited checks for 6 months. Priority. 24/7 support.' }
                ],
                howworks: [
                    { title: 'What is it?', text: 'DV-Lottery Photo Check helps verify your photo before applying to Green Card Lottery.' },
                    { title: 'How it works?', text: 'Upload photo, set guide lines, tap check. System analyzes and shows results.' },
                    { title: 'What we verify?', text: 'Size 600x600. Quality. Head position. Background. Lighting. JPEG format.' },
                    { title: 'Why important?', text: 'Photo rejection is common. We ensure your photo meets all requirements.' },
                    { title: 'How to start?', text: '3 free checks included. Then choose a plan. Promo codes in Telegram channel.' }
                ],
                news: [
                    { date: '28.11.2025', title: 'DV-2027', text: 'Lottery not started yet. Check back for updates.' },
                    { date: '27.11.2025', title: 'Update', text: 'Improved face detection accuracy. Added support for 4 languages.' },
                    { date: '26.11.2025', title: 'Language support', text: 'Now available in Russian, English, French, and Arabic.' }
                ]
            },
            fr: {
                selectLanguage: 'Choisir la langue',
                title: 'DV-Lottery Photo Check',
                attemptslabel: 'Tentatives',
                btnupload: 'T√©l√©charger',
                btnhowworks: 'Comment √ßa marche',
                btnnews: 'Actualit√©s',
                btnpricing: 'Tarifs',
                btndvform: 'DV-2027',
                btnsupport: 'Telegram',
                promoplaceholder: 'Code...',
                btnapply: 'Appliquer',
                btnback: 'Retour',
                btnbuy: 'Acheter',
                descriptiontoggle: 'Description',
                promosuccess: 'Code accept√©! +5',
                promoinvalid: 'Code invalide',
                uploadsuccess: 'Photo t√©l√©charg√©e!',
                supportlink: 'https://t.me/USAvisaPhoto',
                pricing: [
                    { name: 'Gratuit', attempts: '3 v√©rifications', price: '$0', description: '3 v√©rifications gratuites. Analyse compl√®te. T√©l√©chargement r√©sultats.' },
                    { name: 'Standard', attempts: '10 v√©rifications', price: '$2.99', description: '10 v√©rifications. Traitement rapide. T√©l√©chargement HD.' },
                    { name: 'Premium', attempts: '30 v√©rifications', price: '$6.99', description: '30 v√©rifications. Support prioritaire. Traitement par lot.' },
                    { name: 'Agence PRO', attempts: 'Illimit√©', price: '$24.99', description: 'V√©rifications illimit√©es 6 mois. Priorit√©. Support 24/7.' }
                ],
                howworks: [
                    { title: 'Qu\'est-ce que c\'est?', text: 'DV-Lottery Photo Check aide √† v√©rifier votre photo avant d\'appliquer.' },
                    { title: 'Comment √ßa marche?', text: 'T√©l√©chargez, posez les lignes, v√©rifiez. Syst√®me analyse et donne r√©sultats.' },
                    { title: 'Qu\'on v√©rifie?', text: 'Taille 600x600. Qualit√©. Position t√™te. Fond. √âclairage. Format JPEG.' },
                    { title: 'Pourquoi c\'est important?', text: 'Rejet photo fr√©quent. Nous garantissons conformit√©.' },
                    { title: 'Comment commencer?', text: '3 v√©rifications gratuites. Puis choisissez plan. Codes promo Telegram.' }
                ],
                news: [
                    { date: '28.11.2025', title: 'DV-2027', text: 'Loterie pas encore commenc√©e. V√©rifiez mise √† jour.' },
                    { date: '27.11.2025', title: 'Mise √† jour', text: 'Meilleure d√©tection. Support 4 langues.' },
                    { date: '26.11.2025', title: 'Support langue', text: 'Maintenant en russe, anglais, fran√ßais, arabe.' }
                ]
            },
            ar: {
                selectLanguage: 'ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÑÿ∫ÿ©',
                title: 'DV-Lottery Photo Check',
                attemptslabel: 'ŸÖÿ≠ÿßŸàŸÑÿßÿ™',
                btnupload: 'ÿ±ŸÅÿπ ÿµŸàÿ±ÿ©',
                btnhowworks: 'ŸÉŸäŸÅŸäÿ© ÿßŸÑÿπŸÖŸÑ',
                btnnews: 'ÿßŸÑÿ£ÿÆÿ®ÿßÿ±',
                btnpricing: 'ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',
                btndvform: 'DV-2027',
                btnsupport: 'Telegram',
                promoplaceholder: 'ÿßŸÑŸÉŸàÿØ...',
                btnapply: 'ÿ™ÿ∑ÿ®ŸäŸÇ',
                btnback: 'ÿ±ÿ¨Ÿàÿπ',
                btnbuy: 'ÿ¥ÿ±ÿßÿ°',
                descriptiontoggle: 'ÿßŸÑŸàÿµŸÅ',
                promosuccess: 'ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑŸÉŸàÿØ! +5',
                promoinvalid: 'ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠',
                uploadsuccess: 'ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©!',
                supportlink: 'https://t.me/USAvisaPhoto',
                pricing: [
                    { name: 'ŸÖÿ¨ÿßŸÜŸä', attempts: '3 ŸÅÿ≠Ÿàÿµÿßÿ™', price: '$0', description: '3 ŸÅÿ≠Ÿàÿµÿßÿ™ ŸÖÿ¨ÿßŸÜŸäÿ©. ÿ™ÿ≠ŸÑŸäŸÑ ŸÉÿßŸÖŸÑ. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨.' },
                    { name: 'ŸÇŸäÿßÿ≥Ÿä', attempts: '10 ŸÅÿ≠Ÿàÿµÿßÿ™', price: '$2.99', description: '10 ŸÅÿ≠Ÿàÿµÿßÿ™. ŸÖÿπÿßŸÑÿ¨ÿ© ÿ≥ÿ±Ÿäÿπÿ©. ÿ™ÿ≠ŸÖŸäŸÑ HD.' },
                    { name: 'ÿßŸÑŸÖÿ™ŸÖŸäÿ≤', attempts: '30 ŸÅÿ≠Ÿàÿµÿßÿ™', price: '$6.99', description: '30 ŸÅÿ≠Ÿàÿµÿßÿ™. ÿßŸÑÿØÿπŸÖ ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™. ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπÿßÿ™.' },
                    { name: 'ŸàŸÉÿßŸÑÿ© PRO', attempts: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ', price: '$24.99', description: 'ŸÅÿ≠Ÿàÿµÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØÿ© ŸÑŸÖÿØÿ© 6 ÿ£ÿ¥Ÿáÿ±. ÿ£ŸàŸÑŸàŸäÿßÿ™. ÿØÿπŸÖ 24/7.' }
                ],
                howworks: [
                    { title: 'ŸÖÿß Ÿáÿ∞ÿßÿü', text: 'Ÿäÿ≥ÿßÿπÿØ ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ŸÇÿØŸäŸÖ.' },
                    { title: 'ŸÉŸäŸÅŸäÿ© ÿßŸÑÿπŸÖŸÑÿü', text: 'ÿßÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿ∂ÿπ ÿßŸÑÿÆÿ∑Ÿàÿ∑ÿå ÿ™ÿ≠ŸÇŸÇ. ŸÜÿ™ÿßÿ¶ÿ¨ ŸÅŸàÿ±Ÿäÿ©.' },
                    { title: 'ŸÖÿß ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜŸáÿü', text: 'ÿßŸÑÿ≠ÿ¨ŸÖ 600x600. ÿßŸÑÿ¨ŸàÿØÿ©. ÿßŸÑÿ±ÿ£ÿ≥. ÿßŸÑÿÆŸÑŸÅŸäÿ©. ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ JPEG.' },
                    { title: 'ŸÑŸÖÿßÿ∞ÿß ŸÖŸáŸÖÿü', text: 'ÿßŸÑÿµŸàÿ±ÿ© ÿ≥ÿ®ÿ® ÿ±ŸÅÿ∂ ÿ¥ÿßÿ¶ÿπ. ŸÜÿ∂ŸÖŸÜ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ©.' },
                    { title: 'ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ®ÿØÿ°ÿü', text: '3 ŸÅÿ≠Ÿàÿµÿßÿ™ ŸÖÿ¨ÿßŸÜŸäÿ©. ÿßÿÆÿ™ÿ± ÿÆÿ∑ÿ©. ÿ£ŸÉŸàÿßÿØ ŸÅŸä Telegram.' }
                ],
                news: [
                    { date: '28.11.2025', title: 'DV-2027', text: 'ŸÑŸÖ ÿ™ÿ®ÿØÿ£ ÿßŸÑŸäÿßŸÜÿµŸäÿ® ÿ®ÿπÿØ. ÿßÿ®ŸÇŸä ÿπŸÑŸâ ÿßÿ∑ŸÑÿßÿπ.' },
                    { date: '27.11.2025', title: 'ÿ™ÿ≠ÿØŸäÿ´', text: 'ŸÉÿ¥ŸÅ ÿ£ŸÅÿ∂ŸÑ. 4 ŸÑÿ∫ÿßÿ™.' },
                    { date: '26.11.2025', title: 'ÿØÿπŸÖ ÿßŸÑŸÑÿ∫ÿ©', text: 'ÿßŸÑÿ¢ŸÜ ÿ®ŸÑÿ∫ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©.' }
                ]
            }
        };

        // ===== APP STATE =====
        let appState = {
            currentLang: null,
            attempts: 3,
            isAdmin: false,
            languageSelected: false,
            userId: null
        };

        let currentLangIndex = 0;
        let animationInterval = null;

        // ===== PHOTO CHECKER STATE =====
        let photoCheckerState = {
            originalImageData: null,
            image: null,
            canvas: null,
            ctx: null,
            lines: { red: null, blue: null, green: null, brown: null },
            draggingLine: null,
            canvasWidth: 600,
            canvasHeight: 600
        };

        // ===== INITIALIZATION =====
        window.addEventListener('load', initApp);

        function initApp() {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                const webAppData = Telegram.WebApp.initDataUnsafe;
                if (webAppData?.user?.id) {
                    appState.userId = webAppData.user.id;
                    appState.isAdmin = ADMIN_IDS.includes(appState.userId);
                }
            }
            appState.attempts = appState.isAdmin ? 999 : 3;
            setupEventListeners();
            startLanguageAnimation();
        }

        function startLanguageAnimation() {
            const subtitleEl = document.getElementById('splashSubtitle');
            animationInterval = setInterval(() => {
                currentLangIndex = (currentLangIndex + 1) % Object.keys(CONTENT).length;
                const lang = Object.keys(CONTENT)[currentLangIndex];
                subtitleEl.style.opacity = '0';
                setTimeout(() => {
                    subtitleEl.textContent = CONTENT[lang].selectLanguage;
                    subtitleEl.style.opacity = '1';
                }, 300);
            }, 2000);
        }

        function setupEventListeners() {
            document.querySelectorAll('.lang-btn-splash').forEach(btn => {
                btn.addEventListener('click', () => selectLanguage(btn.dataset.lang));
            });

            document.getElementById('menuHowItWorks').addEventListener('click', () => showSection('howWorks'));
            document.getElementById('menuNews').addEventListener('click', () => showSection('news'));
            document.getElementById('menuPricing').addEventListener('click', () => showSection('pricing'));
            document.getElementById('menuDVForm').addEventListener('click', () => showSection('dvForm'));
            document.getElementById('menuSupport').addEventListener('click', () => {
                const link = CONTENT[appState.currentLang].supportlink;
                window.open(link, '_blank');
            });

            ['backBtn1', 'backBtn2', 'backBtn3', 'backBtn4'].forEach(id => {
                document.getElementById(id).addEventListener('click', backToMenu);
            });

            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });

            document.getElementById('photoInput').addEventListener('change', e => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        photoCheckerState.originalImageData = event.target.result;
                        openPhotoChecker();
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
        }

        function selectLanguage(lang) {
            if (animationInterval) clearInterval(animationInterval);
            appState.currentLang = lang;
            appState.languageSelected = true;
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('active');
                updateAllContent();
            }, 300);
        }

        function updateAllContent() {
            const content = CONTENT[appState.currentLang];
            document.getElementById('textHowWorks').textContent = content.btnhowworks;
            document.getElementById('textNews').textContent = content.btnnews;
            document.getElementById('textPricing').textContent = content.btnpricing;
            document.getElementById('textDVForm').textContent = content.btndvform;
            document.getElementById('textSupport').textContent = content.btnsupport;
            document.getElementById('uploadBtn').textContent = content.btnupload;
            document.getElementById('applyPromoBtn').textContent = content.btnapply;
            document.getElementById('attemptsLabel').textContent = content.attemptslabel;
            document.getElementById('appTitle').textContent = content.title;
            document.getElementById('promoCode').placeholder = content.promoplaceholder;
            document.getElementById('lineRedLabel').textContent = '–í–µ—Ä—Ö –≥–æ–ª–æ–≤—ã (–∫—Ä–∞—Å–Ω–∞—è)';
            document.getElementById('lineBlueLabel').textContent = '–ù–∏–∑ –ø–æ–¥–±–æ—Ä–æ–¥–∫–∞ (—Å–∏–Ω—è—è)';
            document.getElementById('lineGreenLabel').textContent = '–£—Ä–æ–≤–µ–Ω—å –≥–ª–∞–∑ (–∑–µ–ª—ë–Ω–∞—è)';
            document.getElementById('lineBrownLabel').textContent = '–¶–µ–Ω—Ç—Ä –ø–æ X (–∫–æ—Ä–∏—á–Ω–µ–≤–∞—è)';

            populateAllContent();
        }

        function populateAllContent() {
            const content = CONTENT[appState.currentLang];

            // Populate How It Works
            let howWorksHTML = '<div class="how-works-unified">';
            content.howworks.forEach(item => {
                howWorksHTML += `<div class="how-works-section"><h3>${item.title}</h3><p>${item.text}</p></div>`;
            });
            howWorksHTML += '</div>';
            document.getElementById('howWorksListdiv').innerHTML = howWorksHTML;

            // Populate News
            let newsHTML = '';
            content.news.forEach(item => {
                newsHTML += `<div class="news-card"><div class="news-card-date">${item.date}</div><div class="news-card-title">${item.title}</div><div class="news-card-text">${item.text}</div></div>`;
            });
            document.getElementById('newsFullListdiv').innerHTML = newsHTML;

            // Populate Pricing
            let pricingHTML = '';
            content.pricing.forEach((item, idx) => {
                pricingHTML += `<div class="pricing-card">
                    <div class="pricing-name">${item.name}</div>
                    <div class="pricing-attempts">${item.attempts}</div>
                    <div class="pricing-price">${item.price}</div>
                    <div class="pricing-description-toggle">üìñ ${content.descriptiontoggle}</div>
                    <div class="pricing-description">${item.description}</div>
                    <button class="btn-buy">${content.btnbuy}</button>
                </div>`;
            });
            document.getElementById('pricingListdiv').innerHTML = pricingHTML;

            // Add description toggle
            document.querySelectorAll('.pricing-description-toggle').forEach(el => {
                el.addEventListener('click', function() {
                    this.nextElementSibling.classList.toggle('active');
                });
            });

            // Populate DV Form
            let dvFormHTML = '<div class="instruction-block"><h3>–î–í-2027</h3><p>–õ–æ—Ç–µ—Ä–µ—è –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏.</p></div>';
            document.getElementById('dvFormListdiv').innerHTML = dvFormHTML;

            // Update back buttons
            ['backBtn1', 'backBtn2', 'backBtn3', 'backBtn4'].forEach(id => {
                document.getElementById(id).textContent = content.btnback;
            });
        }

        function showSection(section) {
            const sectionMap = {
                howWorks: 'howWorksTab',
                news: 'newsTab',
                pricing: 'pricingTab',
                dvForm: 'dvFormTab'
            };
            document.getElementById('menuView').classList.remove('active');
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionMap[section]).classList.add('active');
        }

        function backToMenu() {
            document.getElementById('menuView').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        }

        function applyPromoCode() {
            const code = document.getElementById('promoCode').value;
            if (code === 'PROMO2024') {
                appState.attempts += 5;
                document.getElementById('attemptsCount').textContent = appState.attempts === 999 ? '‚àû' : appState.attempts;
                alert(CONTENT[appState.currentLang].promosuccess);
            } else {
                alert(CONTENT[appState.currentLang].promoinvalid);
            }
            document.getElementById('promoCode').value = '';
        }

        function openPhotoChecker() {
            document.getElementById('photoCheckerModal').style.display = 'flex';
            const canvas = document.getElementById('photoCanvas');
            photoCheckerState.canvas = canvas;
            photoCheckerState.ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = () => {
                photoCheckerState.image = img;
                canvas.width = 600;
                canvas.height = 600;
                const ctx = photoCheckerState.ctx;

                const imgAspect = img.width / img.height;
                let sx = 0, sy = 0, sw = img.width, sh = img.height;

                if (imgAspect > 1) {
                    sw = img.height;
                    sx = (img.width - sw) / 2;
                } else if (imgAspect < 1) {
                    sh = img.width;
                    sy = (img.height - sh) / 2;
                }

                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 600, 600);
                setDefaultLines();
                redrawCanvasWithLines();
                setupCanvasInteraction();
            };
            img.src = photoCheckerState.originalImageData;
        }

        function setDefaultLines() {
            photoCheckerState.lines.red = 150;
            photoCheckerState.lines.blue = 450;
            photoCheckerState.lines.green = 300;
            photoCheckerState.lines.brown = 300;
        }

        function redrawCanvasWithLines() {
            const ctx = photoCheckerState.ctx;
            ctx.clearRect(0, 0, 600, 600);

            const img = photoCheckerState.image;
            if (img) {
                const imgAspect = img.width / img.height;
                let sx = 0, sy = 0, sw = img.width, sh = img.height;
                if (imgAspect > 1) {
                    sw = img.height;
                    sx = (img.width - sw) / 2;
                } else if (imgAspect < 1) {
                    sh = img.width;
                    sy = (img.height - sh) / 2;
                }
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 600, 600);
            }

            // Draw lines
            ctx.strokeStyle = '#8B0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, photoCheckerState.lines.red);
            ctx.lineTo(600, photoCheckerState.lines.red);
            ctx.stroke();

            ctx.strokeStyle = '#00008B';
            ctx.beginPath();
            ctx.moveTo(0, photoCheckerState.lines.blue);
            ctx.lineTo(600, photoCheckerState.lines.blue);
            ctx.stroke();

            ctx.strokeStyle = '#006400';
            ctx.beginPath();
            ctx.moveTo(0, photoCheckerState.lines.green);
            ctx.lineTo(600, photoCheckerState.lines.green);
            ctx.stroke();

            ctx.strokeStyle = '#8B6F47';
            ctx.beginPath();
            ctx.moveTo(photoCheckerState.lines.brown, 0);
            ctx.lineTo(photoCheckerState.lines.brown, 600);
            ctx.stroke();
        }

        function setupCanvasInteraction() {
            const canvas = document.getElementById('photoCanvas');

            function getYFromEvent(e) {
                const rect = canvas.getBoundingClientRect();
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                return (clientY - rect.top) * (600 / rect.height);
            }

            function getLineAtY(y) {
                const tolerance = 20;
                if (Math.abs(y - photoCheckerState.lines.red) < tolerance) return 'red';
                if (Math.abs(y - photoCheckerState.lines.blue) < tolerance) return 'blue';
                if (Math.abs(y - photoCheckerState.lines.green) < tolerance) return 'green';
                return null;
            }

            canvas.addEventListener('mousedown', e => {
                const y = getYFromEvent(e);
                photoCheckerState.draggingLine = getLineAtY(y);
                if (photoCheckerState.draggingLine) canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', e => {
                if (!photoCheckerState.draggingLine) {
                    const y = getYFromEvent(e);
                    canvas.style.cursor = getLineAtY(y) ? 'grab' : 'default';
                    return;
                }
                const y = getYFromEvent(e);
                const newY = Math.max(0, Math.min(600, y));
                photoCheckerState.lines[photoCheckerState.draggingLine] = newY;
                redrawCanvasWithLines();
            });

            canvas.addEventListener('mouseup', () => {
                photoCheckerState.draggingLine = null;
                canvas.style.cursor = 'default';
            });

            canvas.addEventListener('touchstart', e => {
                const rect = canvas.getBoundingClientRect();
                const y = (e.touches[0].clientY - rect.top) * (600 / rect.height);
                photoCheckerState.draggingLine = getLineAtY(y);
            });

            canvas.addEventListener('touchmove', e => {
                if (!photoCheckerState.draggingLine) return;
                const rect = canvas.getBoundingClientRect();
                const y = (e.touches[0].clientY - rect.top) * (600 / rect.height);
                const newY = Math.max(0, Math.min(600, y));
                photoCheckerState.lines[photoCheckerState.draggingLine] = newY;
                redrawCanvasWithLines();
            });

            canvas.addEventListener('touchend', () => {
                photoCheckerState.draggingLine = null;
            });
        }

        function closePhotoChecker() {
            document.getElementById('photoCheckerModal').style.display = 'none';
            photoCheckerState = {
                originalImageData: null, image: null, canvas: null, ctx: null,
                lines: { red: null, blue: null, green: null, brown: null },
                draggingLine: null, canvasWidth: 600, canvasHeight: 600
            };
            document.getElementById('photoInput').value = '';
        }

        // ===== FIXED: CREATE CROPPED PHOTO WITHOUT BLACK BARS =====
        function createCroppedPhoto() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600;
            tempCanvas.height = 600;
            const tempCtx = tempCanvas.getContext('2d');

            const redLine = photoCheckerState.lines.red;
            const blueLine = photoCheckerState.lines.blue;
            const brownLine = photoCheckerState.lines.brown;

            const currentHeadHeight = blueLine - redLine;
            const targetHeadHeight = 600 * 0.60;

            // ===== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê =====
            const hasEnoughSpace = currentHeadHeight >= (600 * 0.50);

            if (!hasEnoughSpace) {
                throw new Error('NOT_ENOUGH_SPACE');
            }

            const scale = targetHeadHeight / currentHeadHeight;

            // ===== –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–• =====
            if (scale > 0.95 && scale < 1.05) {
                const imageData = photoCheckerState.ctx.getImageData(0, 0, 600, 600);
                const cropTop = Math.floor(redLine);
                const cropHeight = Math.floor(blueLine - redLine);

                const halfWidth = 300;
                let cropLeft = Math.floor(brownLine - halfWidth);
                let cropRight = Math.floor(brownLine + halfWidth);

                if (cropLeft < 0) cropLeft = 0;
                if (cropRight > 600) cropRight = 600;

                tempCtx.putImageData(imageData, -cropLeft, -cropTop);

                return tempCanvas;
            }

            tempCtx.scale(scale, scale);

            const targetRedLineY = (600 - targetHeadHeight) / 2 / scale;
            const offsetY = -redLine + targetRedLineY;
            const offsetX = (600 / scale / 2 - brownLine);

            tempCtx.translate(offsetX, offsetY);

            if (photoCheckerState.image) {
                const imgAspect = photoCheckerState.image.width / photoCheckerState.image.height;
                let sx = 0, sy = 0, sw = photoCheckerState.image.width, sh = photoCheckerState.image.height;

                if (imgAspect > 1) {
                    sw = photoCheckerState.image.height;
                    sx = (photoCheckerState.image.width - sw) / 2;
                } else if (imgAspect < 1) {
                    sh = photoCheckerState.image.width;
                    sy = (photoCheckerState.image.height - sh) / 2;
                }

                tempCtx.drawImage(photoCheckerState.image, sx, sy, sw, sh, 0, 0, 600, 600);
            }

            return tempCanvas;
        }

        // ===== START PHOTO CHECK =====
        async function startPhotoCheck() {
            const topHead = photoCheckerState.lines.red;
            const bottomChin = photoCheckerState.lines.blue;
            const headHeight = bottomChin - topHead;

            if (headHeight < 300) {
                alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ —Å –±–æ–ª—å—à–∏–º —Ñ–æ–Ω–æ–º –≤–æ–∫—Ä—É–≥ –ª–∏—Ü–∞.');
                return;
            }

            if (!appState.isAdmin) {
                appState.attempts--;
                document.getElementById('attemptsCount').textContent = appState.attempts === 999 ? '‚àû' : appState.attempts;
            }

            try {
                const croppedCanvas = createCroppedPhoto();
                closePhotoChecker();
                showResultsWithCrop(croppedCanvas);
            } catch (error) {
                if (error.message === 'NOT_ENOUGH_SPACE') {
                    alert('‚ùå –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ. –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ —Ñ–æ–Ω–∞ –≤–æ–∫—Ä—É–≥ –ª–∏—Ü–∞.');
                }
            }
        }

        function showResultsWithCrop(croppedCanvas) {
            const modal = document.createElement('div');
            modal.id = 'resultsModal';
            modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; padding: 20px;';
            
            modal.innerHTML = `
                <button onclick="document.getElementById('resultsModal').remove();" style="align-self: flex-start; background: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 20px;">‚úï ${CONTENT[appState.currentLang].btnback}</button>
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 600px; width: 100%; margin-top: 20px; margin-bottom: 20px;">
                    <h2 style="margin: 0 0 16px 0; color: #333; font-size: 20px;">‚úì –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ</h2>
                    <canvas id="croppedPhotoDisplay" style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; display: block; background: #f0f0f0; max-height: 400px;"></canvas>
                    <button onclick="downloadCroppedPhoto('croppedPhotoDisplay')" style="width: 100%; background: linear-gradient(135deg, #194E84 0%, #1a5a99 100%); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const displayCanvas = document.getElementById('croppedPhotoDisplay');
            const displayCtx = displayCanvas.getContext('2d');
            displayCanvas.width = 600;
            displayCanvas.height = 600;
            displayCtx.drawImage(croppedCanvas, 0, 0);
        }

        function downloadCroppedPhoto(canvasId) {
            const canvas = document.getElementById(canvasId);
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.download = `dv_photo_${new Date().getTime()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

